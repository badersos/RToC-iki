<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#8B5CF6">
    <title>All Pages | Regressor's Tale of Cultivation Wiki</title>
    <link rel="icon" type="image/jpeg" href="../assets/images/seo_eun_hyun_cover.jpg">
    <link rel="stylesheet" href="../styles/main.css">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&display=swap"
        rel="stylesheet">
    <!-- Ionicons for Icons -->
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <script src="../scripts/api-config.js?v=2"></script>
    <style>
        .pages-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .pages-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .pages-header h1 {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff 0%, #A78BFA 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(139, 92, 246, 0.3);
            font-weight: 800;
        }

        .pages-header p {
            color: #aaa;
            font-size: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .pages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .page-preview-card {
            background: rgba(26, 26, 36, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            text-decoration: none;
            display: flex;
            flex-direction: column;
            height: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .page-preview-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: rgba(139, 92, 246, 0.8);
            box-shadow: 0 16px 32px rgba(139, 92, 246, 0.3), 0 0 15px rgba(139, 92, 246, 0.2) inset;
        }

        .page-preview-thumbnail {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #2a2a3a 0%, #1a1a24 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .page-preview-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s ease;
        }

        .page-preview-card:hover .page-preview-thumbnail img {
            transform: scale(1.05);
        }

        .page-preview-thumbnail .page-icon {
            font-size: 4rem;
            color: rgba(139, 92, 246, 0.3);
            z-index: 2;
        }

        .iframe-preview-container {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            overflow: hidden;
            background: #111;
        }

        .iframe-preview-container iframe {
            width: 400%;
            height: 400%;
            transform: scale(0.25);
            transform-origin: top left;
            border: none;
            pointer-events: none;
            opacity: 0.85;
            transition: opacity 0.5s ease;
        }

        .page-preview-card:hover .iframe-preview-container iframe {
            opacity: 1;
        }

        .iframe-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(18, 18, 26, 1) 0%, rgba(18, 18, 26, 0.3) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .page-preview-content {
            padding: 1.5rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .page-preview-name {
            font-size: 1.25rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .page-preview-path {
            font-size: 0.85rem;
            color: #888;
            font-family: 'JetBrains Mono', monospace;
            word-break: break-all;
            margin-bottom: 1rem;
        }

        .page-preview-category {
            display: inline-block;
            padding: 0.35rem 0.85rem;
            background: rgba(139, 92, 246, 0.15);
            color: #C4B5FD;
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            align-self: flex-start;
        }

        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #888;
        }

        .loading-state ion-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #8B5CF6;
        }

        .search-filter {
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .search-filter input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.95rem;
        }

        .search-filter input:focus {
            outline: none;
            border-color: rgba(139, 92, 246, 0.5);
        }

        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.3);
            color: #A78BFA;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.85rem;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: rgba(139, 92, 246, 0.4);
            border-color: rgba(139, 92, 246, 0.6);
        }

        .stats-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(139, 92, 246, 0.1);
            border-radius: 8px;
            margin-bottom: 2rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-item .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #8B5CF6;
        }

        .stat-item .stat-label {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 0.25rem;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-start">
                <a href="../index.html" class="nav-logo">
                <img src="../assets/logo_character.png" alt="RToC" class="nav-logo-img"
                    style="width:36px; height:36px; border-radius:8px; object-fit:cover;">
                RToC Wiki
            </a>

            <button class="nav-toggle">
                <span></span>
                <span></span>
                <span></span>
            </button>

            <ul class="nav-links">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="characters.html" class="nav-link">Characters</a></li>
                <li><a href="concepts.html" class="nav-link">Concepts</a></li>
                <li><a href="plot.html" class="nav-link">Plot</a></li>
                <li><a href="cultivation.html" class="nav-link">Cultivation</a></li>
                <li><a href="martial_arts.html" class="nav-link">Martial Arts</a></li>
                <li><a href="appearances.html" class="nav-link">Appearances</a></li>
                <li><a href="pages.html" class="nav-link">Pages</a></li>
            </ul>
            </div>
            <div class="nav-end">
                <div class="nav-search">
                <ion-icon name="search-outline" class="nav-search-icon"></ion-icon>
                <input type="text" placeholder="Search the wiki...">
            </div>

            <button class="login-btn">Log In</button>
            </div>
        </div>
    </nav>

    <!-- Pages Preview Section -->
    <div class="pages-container">
        <div class="pages-header">
            <h1>All Pages</h1>
            <p>Browse every page in the RToC Wiki</p>
        </div>

        <!-- Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalPages">0</div>
                <div class="stat-label">Total Pages</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="charactersCount">0</div>
                <div class="stat-label">Characters</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="conceptsCount">0</div>
                <div class="stat-label">Concepts</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="cultivationCount">0</div>
                <div class="stat-label">Cultivation</div>
            </div>
        </div>

        <!-- Search and Filter -->
        <div class="search-filter">
            <input type="text" id="pageSearch" placeholder="Search pages by name...">
            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="characters">Characters</button>
                <button class="filter-btn" data-filter="concepts">Concepts</button>
                <button class="filter-btn" data-filter="cultivation">Cultivation</button>
                <button class="filter-btn" data-filter="martial_arts">Martial Arts</button>
                <button class="filter-btn" data-filter="cycles">Cycles</button>
                <button class="filter-btn" data-filter="realms">Realms</button>
            </div>
        </div>

        <!-- Pages Grid -->
        <div id="pagesGrid" class="pages-grid">
            <div class="loading-state">
                <ion-icon name="hourglass-outline"></ion-icon>
                <p>Loading pages...</p>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal-overlay">
        <div class="login-modal">
            <div class="modal-header">
                <button class="modal-close"><ion-icon name="close-outline"></ion-icon></button>
                <h2 class="modal-title">Community Access</h2>
                <p class="modal-subtitle">Join the sect via Discord</p>
            </div>

            <div class="social-login" style="flex-direction: column; gap: 1rem;">
                <button class="social-btn discord" id="discord-login-btn"
                    style="width: 100%; justify-content: center; padding: 1rem;">
                    <ion-icon name="logo-discord" style="font-size: 1.5rem;"></ion-icon>
                    Log In with Discord
                </button>
            </div>

            <p class="modal-subtitle" style="margin-top: 1rem; font-size: 0.8rem; opacity: 0.7;">
                (Authenticates via Discord OAuth2)
            </p>
        </div>
    </div>

    <script src="../scripts/api-config.js?v=2"></script>
    <script src="../scripts/main.js"></script>
    <script>
        let allPages = [];
        let filteredPages = [];

        // Get page name from path
        function getPageName(path) {
            const filename = path.split('/').pop().replace('.html', '');
            // Convert snake_case or kebab-case to Title Case
            return filename
                .split(/[_-]/)
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }

        // Get category from path
        function getCategory(path) {
            if (path.includes('/characters/')) return 'characters';
            if (path.includes('/concepts/')) return 'concepts';
            if (path.includes('/cultivation/')) return 'cultivation';
            if (path.includes('/martial_arts/')) return 'martial_arts';
            if (path.includes('/cycles/')) return 'cycles';
            if (path.includes('/realms/')) return 'realms';
            if (path.includes('characters.html')) return 'characters';
            if (path.includes('concepts.html')) return 'concepts';
            if (path.includes('cultivation.html')) return 'cultivation';
            if (path.includes('martial_arts.html')) return 'martial_arts';
            if (path.includes('realms.html')) return 'realms';
            if (path.includes('plot.html')) return 'plot';
            if (path.includes('appearances.html')) return 'appearances';
            return 'other';
        }

        // Get icon for category
        function getCategoryIcon(category) {
            const icons = {
                'characters': 'person-outline',
                'concepts': 'planet-outline',
                'cultivation': 'flame-outline',
                'martial_arts': 'fitness-outline',
                'cycles': 'repeat-outline',
                'realms': 'map-outline',
                'plot': 'book-outline',
                'appearances': 'eye-outline',
                'other': 'document-text-outline'
            };
            return icons[category] || 'document-text-outline';
        }

        // Get character image path - tries multiple patterns
        function getCharacterImagePath(charName) {
            const patterns = [
                `${charName}_cover.jpg`,
                `${charName}_cover.png`,
                `${charName}_profile.png`,
                `${charName}_full.png`,
                `${charName}_art.png`,
                `${charName}.png`,
                `${charName}.jpg`,
                `${charName}_manhwa.jpg`,
                `${charName}_novel.jpg`,
                `${charName}_dark.png`,
                `${charName}_header_text.png`
            ];

            // Return the first pattern - browser will handle 404s via onerror
            // We'll use a cascade approach with multiple img tags
            return patterns.map(pattern => `../assets/images/${pattern}`).join(',');
        }

        // Create page preview card
        function createPageCard(page) {
            const name = getPageName(page.path);
            const category = getCategory(page.path);
            const icon = getCategoryIcon(category);

            // Try to find a thumbnail image
            let thumbnailImg = '';

            const charName = page.path.split('/').pop().replace('.html', '');
            const imagePatterns = [
                `${charName}_cover.jpg`,
                `${charName}_cover.png`,
                `${charName}_profile.png`,
                `${charName}_full.png`,
                `${charName}_art.png`,
                `${charName}.png`,
                `${charName}.jpg`,
                `${charName}_manhwa.jpg`,
                `${charName}_novel.jpg`,
                `${charName}_dark.png`,
                `${charName}_placeholder.png`,
                `${charName}_placeholder.jpg`
            ];

            const imageSources = imagePatterns.map(pattern =>
                `../assets/images/${pattern}`
            );

            if (category === 'cycles') {
                const cycleNum = charName.match(/\d+/)?.[0];
                if (cycleNum) {
                    imageSources.unshift(`../assets/images/timeline_${cycleNum}_cycle.png`);
                }
            }

            // Add iframe preview fallback
            thumbnailImg = imageSources.map((src, idx) =>
                `<img class="char-preview-img" data-src="${src}" 
                    style="display: none; width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; z-index: 2;">`
            ).join('') +
                `<div class="iframe-preview-container" style="display: none;">
                <iframe data-src="/${page.path}" loading="lazy" scrolling="no" tabindex="-1"></iframe>
                <div class="iframe-preview-overlay"></div>
            </div>
            <div class="page-icon" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1;">
                <ion-icon name="${icon}"></ion-icon>
            </div>`;

            return `
                <a href="/${page.path}" class="page-preview-card" data-category="${category}" data-name="${name.toLowerCase()}">
                    <div class="page-preview-thumbnail" style="position: relative;">
                        ${thumbnailImg}
                    </div>
                    <div class="page-preview-content">
                        <div>
                            <div class="page-preview-name">${name}</div>
                            <div class="page-preview-path">/${page.path}</div>
                        </div>
                        <div class="page-preview-category">${category.replace('_', ' ')}</div>
                    </div>
                </a>
            `;
        }

        // Filter pages
        function filterPages() {
            const searchTerm = document.getElementById('pageSearch').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-btn.active')?.dataset.filter || 'all';

            filteredPages = allPages.filter(page => {
                const name = getPageName(page.path).toLowerCase();
                const category = getCategory(page.path);
                const path = page.path.toLowerCase();

                const matchesSearch = !searchTerm || name.includes(searchTerm) || path.includes(searchTerm);
                const matchesFilter = activeFilter === 'all' || category === activeFilter;

                return matchesSearch && matchesFilter;
            });

            renderPages();
            updateStats();
        }

        // Render pages
        function renderPages() {
            const grid = document.getElementById('pagesGrid');

            if (filteredPages.length === 0) {
                grid.innerHTML = `
                    <div class="loading-state" style="grid-column: 1/-1;">
                        <ion-icon name="search-outline"></ion-icon>
                        <p>No pages found matching your search.</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filteredPages.map(page => createPageCard(page)).join('');

            // After rendering, handle image loading for all pages with cascade
            setTimeout(() => {
                document.querySelectorAll('.page-preview-thumbnail').forEach(thumbnail => {
                    const images = thumbnail.querySelectorAll('.char-preview-img');
                    const iframeContainer = thumbnail.querySelector('.iframe-preview-container');
                    const icon = thumbnail.querySelector('.page-icon');

                    if (images.length > 0) {
                        let imageLoaded = false;

                        const tryLoadImage = (index) => {
                            if (index >= images.length) {
                                // All images failed, show iframe!
                                if (iframeContainer) {
                                    iframeContainer.style.display = 'block';
                                    const iframe = iframeContainer.querySelector('iframe');
                                    if (iframe && iframe.getAttribute('data-src')) {
                                        iframe.src = iframe.getAttribute('data-src');
                                    }
                                } else if (icon) {
                                    icon.style.display = 'flex';
                                }
                                return;
                            }

                            const img = images[index];
                            const testImg = new Image();
                            testImg.onload = () => {
                                if (!imageLoaded) {
                                    imageLoaded = true;
                                    img.style.display = 'block';
                                    img.src = img.getAttribute('data-src');
                                }
                            };
                            testImg.onerror = () => {
                                tryLoadImage(index + 1);
                            };
                            testImg.src = img.getAttribute('data-src');
                        };

                        tryLoadImage(0);
                    } else if (iframeContainer) {
                        iframeContainer.style.display = 'block';
                        const iframe = iframeContainer.querySelector('iframe');
                        if (iframe && iframe.getAttribute('data-src')) {
                            iframe.src = iframe.getAttribute('data-src');
                        }
                    }
                });
            }, 50);
        }

        // Update stats
        function updateStats() {
            const categories = {
                characters: 0,
                concepts: 0,
                cultivation: 0
            };

            filteredPages.forEach(page => {
                const cat = getCategory(page.path);
                if (categories.hasOwnProperty(cat)) {
                    categories[cat]++;
                }
            });

            document.getElementById('totalPages').textContent = filteredPages.length;
            document.getElementById('charactersCount').textContent = categories.characters;
            document.getElementById('conceptsCount').textContent = categories.concepts;
            document.getElementById('cultivationCount').textContent = categories.cultivation;
        }

        // Load all pages
        async function loadPages() {
            try {
                const response = await window.rtocFetch('/api/pages');
                const data = await response.json();

                if (data.status === 'success') {
                    // Filter out admin pages, templates, and auth pages
                    allPages = data.pages.filter(page => {
                        const path = page.path.toLowerCase();
                        return !path.includes('admin/') &&
                            !path.includes('template') &&
                            !path.includes('auth/') &&
                            !path.includes('callback') &&
                            path !== 'index.html';
                    });

                    // Sort by name
                    allPages.sort((a, b) => {
                        const nameA = getPageName(a.path);
                        const nameB = getPageName(b.path);
                        return nameA.localeCompare(nameB);
                    });

                    filteredPages = [...allPages];
                    renderPages();
                    updateStats();
                }
            } catch (error) {
                console.error('Failed to load pages:', error);
                document.getElementById('pagesGrid').innerHTML = `
                    <div class="loading-state" style="grid-column: 1/-1;">
                        <ion-icon name="alert-circle-outline"></ion-icon>
                        <p>Failed to load pages. Please try again later.</p>
                    </div>
                `;
            }
        }

        // Event listeners
        document.getElementById('pageSearch').addEventListener('input', filterPages);

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                filterPages();
            });
        });

        // Load pages on page load
        loadPages();
    </script>
</body>

</html>